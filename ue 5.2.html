<!DOCTYPE html><html><head>
      <title>ue 5.2</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\98329\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.11\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="unreal-mesh-render-pipeline-analysis">Unreal Mesh Render Pipeline Analysis </h1>
<h2 id="unreal-engine-mesh-draw-pipeline">Unreal Engine Mesh Draw Pipeline </h2>
<p><a href="https://zhuanlan.zhihu.com/p/574116410">原文链接</a> <a href="https://pic1.zhimg.com/70/v2-1c622885971aef9b6c4a3ee1a6fca6f4_1440w.avis?source=172ae18b&amp;biz_tag=Post">图片链接</a><br>
<img src="./UnrealMeshRenderPipeline.png" alt=" Unreal Engine Mesh Draw Pipeline "><br>
<a href="UERenderPipeline.html">网格处理的类与方法</a><br>
<img src="BD97CC31-ED8F-4c88-8F6A-CFE1530EBB3E.png" alt="网格处理的类与方法缩略图"></p>
<h2 id="render-path-overview">Render Path Overview </h2>
<h3 id="entry-overview">Entry Overview </h3>
<p>Unreal Engine 5.2 中的渲染绘制的入口在 <code>FViewPort::Draw()</code>，调用堆栈如下图所示，<code>Draw()</code>函数由引擎的更新函数<code>Tick()</code>每帧调用。<br>
<img src="image-23.png" alt="Alt text"><br>
<code>Draw()</code>中会调用<code>FRendererModule::BeginRenderingViewFamily</code>(<code>FRendererModule::BeginRenderingViewFamilies</code>)，向渲染线程发送消息以开始渲染流程。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// Engine\Source\Runtime\Engine\Private\GameViewportClient.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">UGameViewportClient</span><span class="token double-colon punctuation">::</span><span class="token function">Draw</span><span class="token punctuation">(</span>FViewport<span class="token operator">*</span> InViewport<span class="token punctuation">,</span> FCanvas<span class="token operator">*</span> SceneCanvas<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token function">GetRendererModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BeginRenderingViewFamily</span><span class="token punctuation">(</span>SceneCanvas<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ViewFamily<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><p><code>FRendererModule::BeginRenderingViewFamilies</code>中会入队在渲染线程执行的命令<code>RenderViewFamilies_RenderThread</code>，该方法会调用<code>FDeferredShadingSceneRenderer::Render</code>或<code>FMobileSceneRenderer::Render</code>开启场景的绘制。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// Engine\Source\Runtime\Renderer\Private\SceneRendering.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">FRendererModule</span><span class="token double-colon punctuation">::</span><span class="token function">BeginRenderingViewFamilies</span><span class="token punctuation">(</span>FCanvas<span class="token operator">*</span> Canvas<span class="token punctuation">,</span> TArrayView<span class="token operator">&lt;</span>FSceneViewFamily<span class="token operator">*</span><span class="token operator">&gt;</span> ViewFamilies<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token function">ENQUEUE_RENDER_COMMAND</span><span class="token punctuation">(</span>FDrawSceneCommand<span class="token punctuation">)</span><span class="token punctuation">(</span>
			<span class="token punctuation">[</span>LocalSceneRenderers <span class="token operator">=</span> <span class="token function">CopyTemp</span><span class="token punctuation">(</span>SceneRenderers<span class="token punctuation">)</span><span class="token punctuation">,</span> DrawSceneEnqueue<span class="token punctuation">]</span><span class="token punctuation">(</span>FRHICommandListImmediate<span class="token operator">&amp;</span> RHICmdList<span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				uint64 SceneRenderStart <span class="token operator">=</span> <span class="token class-name">FPlatformTime</span><span class="token double-colon punctuation">::</span><span class="token function">Cycles64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword keyword-const">const</span> <span class="token keyword keyword-float">float</span> StartDelayMillisec <span class="token operator">=</span> <span class="token class-name">FPlatformTime</span><span class="token double-colon punctuation">::</span><span class="token function">ToMilliseconds64</span><span class="token punctuation">(</span>SceneRenderStart <span class="token operator">-</span> DrawSceneEnqueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">CSV_CUSTOM_STAT_GLOBAL</span><span class="token punctuation">(</span>DrawSceneCommand_StartDelay<span class="token punctuation">,</span> StartDelayMillisec<span class="token punctuation">,</span> ECsvCustomStatOp<span class="token double-colon punctuation">::</span>Set<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">RenderViewFamilies_RenderThread</span><span class="token punctuation">(</span>RHICmdList<span class="token punctuation">,</span> LocalSceneRenderers<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">FlushPendingDeleteRHIResources_RenderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">RenderViewFamilies_RenderThread</span><span class="token punctuation">(</span>FRHICommandListImmediate<span class="token operator">&amp;</span> RHICmdList<span class="token punctuation">,</span> <span class="token keyword keyword-const">const</span> TArray<span class="token operator">&lt;</span>FSceneRenderer<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> SceneRenderers<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// Render the scene.</span>
	SceneRenderer<span class="token operator">-&gt;</span><span class="token function">Render</span><span class="token punctuation">(</span>GraphBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre><p>我们主要关注延迟渲染管线，<code>FDeferredShadingSceneRenderer::Render</code>中调用<code>FDeferredShadingSceneRenderer::BeginInitViews</code>开始初始化场景的视图、检查可见性、构建可视网格绘制命令等，调用<code>RenderXXXPass()</code>以开始不同Pass的渲染。</p>
<h3 id="call-stack-analysis">Call Stack Analysis </h3>
<p>下面我们从三个较为重要的 <em><strong>CallStack</strong></em> 入手进行分析</p>
<h4 id="call-stack1-get-meshbatch">Call Stack1: Get MeshBatch </h4>
<p><img src="image-5.png" alt="Call Stack1: Get MeshBatch"><br>
<code>FSceneRenderer::GatherDynamicMeshElements</code>在执行可见性检查<code>FSceneRenderer::ComputeViewVisibility</code>时被调用，其中的<code>FPrimitiveSceneProxy::GetDynamicMeshElements</code>是给每个图元对象向渲染器（收集器）添加可见图元元素的机会，由具体的子类实现，如<code>FLineBatcherSceneProxy</code>, <code>FStaticMeshSceneProxy</code>,<code>FSkeletalMeshSceneProxy</code>等。<br>
<code>Engine\Source\Runtime\Renderer\Private\SceneVisibility.cpp</code></p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-void">void</span> <span class="token class-name">FSceneRenderer</span><span class="token double-colon punctuation">::</span><span class="token function">GatherDynamicMeshElements</span><span class="token punctuation">(</span>
	TArray<span class="token operator">&lt;</span>FViewInfo<span class="token operator">&gt;</span><span class="token operator">&amp;</span> InViews<span class="token punctuation">,</span> 
	<span class="token keyword keyword-const">const</span> FScene<span class="token operator">*</span> InScene<span class="token punctuation">,</span> 
	<span class="token keyword keyword-const">const</span> FSceneViewFamily<span class="token operator">&amp;</span> InViewFamily<span class="token punctuation">,</span> 
	FGlobalDynamicIndexBuffer<span class="token operator">&amp;</span> DynamicIndexBuffer<span class="token punctuation">,</span>
	FGlobalDynamicVertexBuffer<span class="token operator">&amp;</span> DynamicVertexBuffer<span class="token punctuation">,</span>
	FGlobalDynamicReadBuffer<span class="token operator">&amp;</span> DynamicReadBuffer<span class="token punctuation">,</span>
	<span class="token keyword keyword-const">const</span> FPrimitiveViewMasks<span class="token operator">&amp;</span> HasDynamicMeshElementsMasks<span class="token punctuation">,</span> 
	<span class="token keyword keyword-const">const</span> FPrimitiveViewMasks<span class="token operator">&amp;</span> HasDynamicEditorMeshElementsMasks<span class="token punctuation">,</span>
	FMeshElementCollector<span class="token operator">&amp;</span> Collector<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>int32 PrimitiveIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> PrimitiveIndex <span class="token operator">&lt;</span> NumPrimitives<span class="token punctuation">;</span> <span class="token operator">++</span>PrimitiveIndex<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword keyword-const">const</span> uint8 ViewMask <span class="token operator">=</span> HasDynamicMeshElementsMasks<span class="token punctuation">[</span>PrimitiveIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>ViewMask <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				Collector<span class="token punctuation">.</span><span class="token function">SetPrimitive</span><span class="token punctuation">(</span>PrimitiveSceneInfo<span class="token operator">-&gt;</span>Proxy<span class="token punctuation">,</span> PrimitiveSceneInfo<span class="token operator">-&gt;</span>DefaultDynamicHitProxyId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				PrimitiveSceneInfo<span class="token operator">-&gt;</span>Proxy<span class="token operator">-&gt;</span><span class="token function">GetDynamicMeshElements</span><span class="token punctuation">(</span>InViewFamily<span class="token punctuation">.</span>Views<span class="token punctuation">,</span> InViewFamily<span class="token punctuation">,</span> ViewMaskFinal<span class="token punctuation">,</span> Collector<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><p>以<code>FStaticMeshSceneProxy</code>为例，会根据不同的LOD索引，为每个Section网格添加一个<code>FMeshBatch</code>，然后将<code>FMeshBatch</code>加入到<code>FMeshElementCollector</code><br>
<code>Engine\Source\Runtime\Engine\Private\StaticMeshRender.cpp</code></p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-void">void</span> <span class="token class-name">FStaticMeshSceneProxy</span><span class="token double-colon punctuation">::</span><span class="token function">GetDynamicMeshElements</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> TArray<span class="token operator">&lt;</span><span class="token keyword keyword-const">const</span> FSceneView<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> Views<span class="token punctuation">,</span> <span class="token keyword keyword-const">const</span> FSceneViewFamily<span class="token operator">&amp;</span> ViewFamily<span class="token punctuation">,</span> uint32 VisibilityMap<span class="token punctuation">,</span> FMeshElementCollector<span class="token operator">&amp;</span> Collector<span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>int32 BatchIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> BatchIndex <span class="token operator">&lt;</span> NumBatches<span class="token punctuation">;</span> BatchIndex<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// GetWireframeMeshElement will try SetIndexSource at section index 0</span>
    <span class="token comment">// and GetMeshElement loops over sections, therefore does not have this issue</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>LODModel<span class="token punctuation">.</span>Sections<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        FMeshBatch <span class="token operator">&amp;</span>Mesh <span class="token operator">=</span> Collector<span class="token punctuation">.</span><span class="token function">AllocateMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		Collector<span class="token punctuation">.</span><span class="token function">AddMesh</span><span class="token punctuation">(</span>ViewIndex<span class="token punctuation">,</span> MeshElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="call-stack2-build-meshdrawcommand">Call Stack2: Build MeshDrawCommand </h4>
<p><img src="image-6.png" alt="Call Stack: Build MeshDrawCommand"><br>
<code>FSceneRenderer::ComputeViewVisibility</code>中除了<code>FSceneRenderer::GatherDynamicMeshElements</code>外还有一个关键的函数<code>FSceneRenderer::SetupMeshPass</code>，这个函数会遍历所有Pass的类型，创建对应的<code>FMeshPassProcessor</code>，再调用<code>FParallelMeshDrawCommandPass::DispatchPassSetup</code>开始该Pass的创建与MeshDrawCommand的构建。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// Engine\Source\Runtime\Renderer\Private\SceneRendering.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">FSceneRenderer</span><span class="token double-colon punctuation">::</span><span class="token function">SetupMeshPass</span><span class="token punctuation">(</span>FViewInfo<span class="token operator">&amp;</span> View<span class="token punctuation">,</span> FExclusiveDepthStencil<span class="token double-colon punctuation">::</span>Type BasePassDepthStencilAccess<span class="token punctuation">,</span> FViewCommands<span class="token operator">&amp;</span> ViewCommands<span class="token punctuation">,</span> FInstanceCullingManager<span class="token operator">&amp;</span> InstanceCullingManager<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			FMeshPassProcessor<span class="token operator">*</span> MeshPassProcessor <span class="token operator">=</span> <span class="token class-name">FPassProcessorManager</span><span class="token double-colon punctuation">::</span><span class="token function">CreateMeshPassProcessor</span><span class="token punctuation">(</span>ShadingPath<span class="token punctuation">,</span> PassType<span class="token punctuation">,</span> Scene<span class="token operator">-&gt;</span><span class="token function">GetFeatureLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> <span class="token operator">&amp;</span>View<span class="token punctuation">,</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			FParallelMeshDrawCommandPass<span class="token operator">&amp;</span> Pass <span class="token operator">=</span> View<span class="token punctuation">.</span>ParallelMeshDrawCommandPasses<span class="token punctuation">[</span>PassIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			Pass<span class="token punctuation">.</span><span class="token function">DispatchPassSetup</span><span class="token punctuation">(</span>
				Scene<span class="token punctuation">,</span>
				View<span class="token punctuation">,</span>
				<span class="token function">FInstanceCullingContext</span><span class="token punctuation">(</span>FeatureLevel<span class="token punctuation">,</span> <span class="token operator">&amp;</span>InstanceCullingManager<span class="token punctuation">,</span> ViewIds<span class="token punctuation">,</span> View<span class="token punctuation">.</span>PrevViewInfo<span class="token punctuation">.</span>HZB<span class="token punctuation">,</span> InstanceCullingMode<span class="token punctuation">,</span> CullingFlags<span class="token punctuation">)</span><span class="token punctuation">,</span>
				PassType<span class="token punctuation">,</span>
				BasePassDepthStencilAccess<span class="token punctuation">,</span>
				MeshPassProcessor<span class="token punctuation">,</span>
				View<span class="token punctuation">.</span>DynamicMeshElements<span class="token punctuation">,</span>
				<span class="token operator">&amp;</span>View<span class="token punctuation">.</span>DynamicMeshElementsPassRelevance<span class="token punctuation">,</span>
				View<span class="token punctuation">.</span>NumVisibleDynamicMeshElements<span class="token punctuation">[</span>PassType<span class="token punctuation">]</span><span class="token punctuation">,</span>
				ViewCommands<span class="token punctuation">.</span>DynamicMeshCommandBuildRequests<span class="token punctuation">[</span>PassType<span class="token punctuation">]</span><span class="token punctuation">,</span>
				ViewCommands<span class="token punctuation">.</span>NumDynamicMeshCommandBuildRequestElements<span class="token punctuation">[</span>PassType<span class="token punctuation">]</span><span class="token punctuation">,</span>
				ViewCommands<span class="token punctuation">.</span>MeshCommands<span class="token punctuation">[</span>PassIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><p><code>FParallelMeshDrawCommandPass::DispatchPassSetup</code>中先收集Pass相关的信息到TaskContext中，再调用<code>FMeshDrawCommandPassSetupTask::AnyThreadTask</code>创建任务和<code>FMeshDrawCommandInitResourcesTask::AnyThreadTask</code>初始化资源。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// Engine\Source\Runtime\Renderer\Private\MeshDrawCommands.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">FParallelMeshDrawCommandPass</span><span class="token double-colon punctuation">::</span><span class="token function">DispatchPassSetup</span><span class="token punctuation">(</span>
	FScene<span class="token operator">*</span> Scene<span class="token punctuation">,</span>
	<span class="token keyword keyword-const">const</span> FViewInfo<span class="token operator">&amp;</span> View<span class="token punctuation">,</span>
	FInstanceCullingContext<span class="token operator">&amp;&amp;</span> InstanceCullingContext<span class="token punctuation">,</span>
	EMeshPass<span class="token double-colon punctuation">::</span>Type PassType<span class="token punctuation">,</span>
	FExclusiveDepthStencil<span class="token double-colon punctuation">::</span>Type BasePassDepthStencilAccess<span class="token punctuation">,</span>
	FMeshPassProcessor<span class="token operator">*</span> MeshPassProcessor<span class="token punctuation">,</span>
	<span class="token keyword keyword-const">const</span> TArray<span class="token operator">&lt;</span>FMeshBatchAndRelevance<span class="token punctuation">,</span> SceneRenderingAllocator<span class="token operator">&gt;</span><span class="token operator">&amp;</span> DynamicMeshElements<span class="token punctuation">,</span>
	<span class="token keyword keyword-const">const</span> TArray<span class="token operator">&lt;</span>FMeshPassMask<span class="token punctuation">,</span> SceneRenderingAllocator<span class="token operator">&gt;</span><span class="token operator">*</span> DynamicMeshElementsPassRelevance<span class="token punctuation">,</span>
	int32 NumDynamicMeshElements<span class="token punctuation">,</span>
	TArray<span class="token operator">&lt;</span><span class="token keyword keyword-const">const</span> FStaticMeshBatch<span class="token operator">*</span><span class="token punctuation">,</span> SceneRenderingAllocator<span class="token operator">&gt;</span><span class="token operator">&amp;</span> InOutDynamicMeshCommandBuildRequests<span class="token punctuation">,</span>
	int32 NumDynamicMeshCommandBuildRequestElements<span class="token punctuation">,</span>
	FMeshCommandOneFrameArray<span class="token operator">&amp;</span> InOutMeshDrawCommands<span class="token punctuation">,</span>
	FMeshPassProcessor<span class="token operator">*</span> MobileBasePassCSMMeshPassProcessor<span class="token punctuation">,</span>
	FMeshCommandOneFrameArray<span class="token operator">*</span> InOutMobileBasePassCSMMeshDrawCommands
<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>bExecuteInParallel<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token function">IsOnDemandShaderCreationEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				TaskEventRef <span class="token operator">=</span> <span class="token class-name">TGraphTask</span><span class="token operator">&lt;</span>FMeshDrawCommandPassSetupTask<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">CreateTask</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">,</span> <span class="token class-name">ENamedThreads</span><span class="token double-colon punctuation">::</span><span class="token function">GetRenderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstructAndDispatchWhenReady</span><span class="token punctuation">(</span>TaskContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword keyword-else">else</span>
			<span class="token punctuation">{</span>
				FGraphEventArray DependentGraphEvents<span class="token punctuation">;</span>
				DependentGraphEvents<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">TGraphTask</span><span class="token operator">&lt;</span>FMeshDrawCommandPassSetupTask<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">CreateTask</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">,</span> <span class="token class-name">ENamedThreads</span><span class="token double-colon punctuation">::</span><span class="token function">GetRenderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstructAndDispatchWhenReady</span><span class="token punctuation">(</span>TaskContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				TaskEventRef <span class="token operator">=</span> <span class="token class-name">TGraphTask</span><span class="token operator">&lt;</span>FMeshDrawCommandInitResourcesTask<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">CreateTask</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DependentGraphEvents<span class="token punctuation">,</span> <span class="token class-name">ENamedThreads</span><span class="token double-colon punctuation">::</span><span class="token function">GetRenderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstructAndDispatchWhenReady</span><span class="token punctuation">(</span>TaskContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-else">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">QUICK_SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>STAT_MeshPassSetupImmediate<span class="token punctuation">)</span><span class="token punctuation">;</span>
			FMeshDrawCommandPassSetupTask <span class="token function">Task</span><span class="token punctuation">(</span>TaskContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
			Task<span class="token punctuation">.</span><span class="token function">AnyThreadTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsOnDemandShaderCreationEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				FMeshDrawCommandInitResourcesTask <span class="token function">DependentTask</span><span class="token punctuation">(</span>TaskContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
				DependentTask<span class="token punctuation">.</span><span class="token function">AnyThreadTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><p><code>GenerateDynamicMeshDrawCommands</code>将会转换指定<code>EMeshPass</code>中的每个<code>FMeshBatch</code>到一组<code>FMeshDrawCommand</code>，其中既会处理动态网格批次<code>DynamicMeshBatches</code>也会处理静态网格批次<code>StaticMeshBatches</code>，<code>DynamicMeshCommandBuildRequests</code>的数量即<code>NumDynamicMeshCommandBuildRequestElements</code>，代表<code>StaticMeshBatches</code>的数量。<br>
<code>AddMeshBatch</code>为开始将该<code>FMeshBatch</code>转换成<code>FMeshDrawCommand</code>的入口。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// Engine\Source\Runtime\Renderer\Private\MeshDrawCommands.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token function">GenerateDynamicMeshDrawCommands</span><span class="token punctuation">(</span>
	<span class="token keyword keyword-const">const</span> FViewInfo<span class="token operator">&amp;</span> View<span class="token punctuation">,</span>
	EShadingPath ShadingPath<span class="token punctuation">,</span>
	EMeshPass<span class="token double-colon punctuation">::</span>Type PassType<span class="token punctuation">,</span>
	FMeshPassProcessor<span class="token operator">*</span> PassMeshProcessor<span class="token punctuation">,</span>
	<span class="token keyword keyword-const">const</span> TArray<span class="token operator">&lt;</span>FMeshBatchAndRelevance<span class="token punctuation">,</span> SceneRenderingAllocator<span class="token operator">&gt;</span><span class="token operator">&amp;</span> DynamicMeshElements<span class="token punctuation">,</span>
	<span class="token keyword keyword-const">const</span> TArray<span class="token operator">&lt;</span>FMeshPassMask<span class="token punctuation">,</span> SceneRenderingAllocator<span class="token operator">&gt;</span><span class="token operator">*</span> DynamicMeshElementsPassRelevance<span class="token punctuation">,</span>
	int32 MaxNumDynamicMeshElements<span class="token punctuation">,</span>
	<span class="token keyword keyword-const">const</span> TArray<span class="token operator">&lt;</span><span class="token keyword keyword-const">const</span> FStaticMeshBatch<span class="token operator">*</span><span class="token punctuation">,</span> SceneRenderingAllocator<span class="token operator">&gt;</span><span class="token operator">&amp;</span> DynamicMeshCommandBuildRequests<span class="token punctuation">,</span>
	int32 MaxNumBuildRequestElements<span class="token punctuation">,</span>
	FMeshCommandOneFrameArray<span class="token operator">&amp;</span> VisibleCommands<span class="token punctuation">,</span>
	FDynamicMeshDrawCommandStorage<span class="token operator">&amp;</span> MeshDrawCommandStorage<span class="token punctuation">,</span>
	FGraphicsMinimalPipelineStateSet<span class="token operator">&amp;</span> MinimalPipelineStatePassSet<span class="token punctuation">,</span>
	<span class="token keyword keyword-bool">bool</span><span class="token operator">&amp;</span> NeedsShaderInitialisation
<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> int32 NumCommandsBefore <span class="token operator">=</span> VisibleCommands<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> int32 NumDynamicMeshBatches <span class="token operator">=</span> DynamicMeshElements<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>int32 MeshIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> MeshIndex <span class="token operator">&lt;</span> NumDynamicMeshBatches<span class="token punctuation">;</span> MeshIndex<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DynamicMeshElementsPassRelevance <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>DynamicMeshElementsPassRelevance<span class="token punctuation">)</span><span class="token punctuation">[</span>MeshIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>PassType<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token keyword keyword-const">const</span> FMeshBatchAndRelevance<span class="token operator">&amp;</span> MeshAndRelevance <span class="token operator">=</span> DynamicMeshElements<span class="token punctuation">[</span>MeshIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword keyword-const">const</span> uint64 BatchElementMask <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0ull</span><span class="token punctuation">;</span>

				PassMeshProcessor<span class="token operator">-&gt;</span><span class="token function">AddMeshBatch</span><span class="token punctuation">(</span><span class="token operator">*</span>MeshAndRelevance<span class="token punctuation">.</span>Mesh<span class="token punctuation">,</span> BatchElementMask<span class="token punctuation">,</span> MeshAndRelevance<span class="token punctuation">.</span>PrimitiveSceneProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-const">const</span> int32 NumCommandsGenerated <span class="token operator">=</span> VisibleCommands<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> NumCommandsBefore<span class="token punctuation">;</span>
		<span class="token function">checkf</span><span class="token punctuation">(</span>NumCommandsGenerated <span class="token operator">&lt;=</span> MaxNumDynamicMeshElements<span class="token punctuation">,</span>
			<span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"Generated %d mesh draw commands for DynamicMeshElements, while preallocating resources only for %d of them."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NumCommandsGenerated<span class="token punctuation">,</span> MaxNumDynamicMeshElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> int32 NumCommandsBefore <span class="token operator">=</span> VisibleCommands<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> int32 NumStaticMeshBatches <span class="token operator">=</span> DynamicMeshCommandBuildRequests<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>int32 MeshIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> MeshIndex <span class="token operator">&lt;</span> NumStaticMeshBatches<span class="token punctuation">;</span> MeshIndex<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword keyword-const">const</span> FStaticMeshBatch<span class="token operator">*</span> StaticMeshBatch <span class="token operator">=</span> DynamicMeshCommandBuildRequests<span class="token punctuation">[</span>MeshIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword keyword-const">const</span> uint64 DefaultBatchElementMask <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0ul</span><span class="token punctuation">;</span>
			PassMeshProcessor<span class="token operator">-&gt;</span><span class="token function">AddMeshBatch</span><span class="token punctuation">(</span><span class="token operator">*</span>StaticMeshBatch<span class="token punctuation">,</span> DefaultBatchElementMask<span class="token punctuation">,</span> StaticMeshBatch<span class="token operator">-&gt;</span>PrimitiveSceneInfo<span class="token operator">-&gt;</span>Proxy<span class="token punctuation">,</span> StaticMeshBatch<span class="token operator">-&gt;</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-const">const</span> int32 NumCommandsGenerated <span class="token operator">=</span> VisibleCommands<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> NumCommandsBefore<span class="token punctuation">;</span>
		<span class="token function">checkf</span><span class="token punctuation">(</span>NumCommandsGenerated <span class="token operator">&lt;=</span> MaxNumBuildRequestElements<span class="token punctuation">,</span>
			<span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"Generated %d mesh draw commands for DynamicMeshCommandBuildRequests, while preallocating resources only for %d of them."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NumCommandsGenerated<span class="token punctuation">,</span> MaxNumBuildRequestElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><p><code>FMeshPassProcessor::BuildMeshDrawCommands</code>中会创建<code>FMeshDrawCommand</code>并填充信息，然后将其添加到<code>DrawListContext</code>中，最后再执行<code>FinalizeCommand</code>完成MeshDrawCommands的构建。</p>
<p>以<code>FDynamicPassMeshDrawListContext</code>为例，<code>FDynamicPassMeshDrawListContext::FinalizeCommand</code>中使用传入的<code>FMeshDrawCommand</code>创建<code>FVisibleMeshDrawCommand</code>并添加到<code>FMeshProcessor</code>的<code>DrawList</code>中， <code>DrawList</code>的类型是<code>FMeshCommandOneFrameArray</code>，<code>FMeshCommandOneFrameArray</code>的定义如下：<br>
<code>typedef TArray&lt;FVisibleMeshDrawCommand, SceneRenderingAllocator&gt; FMeshCommandOneFrameArray;</code></p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// Engine\Source\Runtime\Renderer\Public\MeshPassProcessor.h</span>
	<span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-void">void</span> <span class="token function">FinalizeCommand</span><span class="token punctuation">(</span>
		<span class="token keyword keyword-const">const</span> FMeshBatch<span class="token operator">&amp;</span> MeshBatch<span class="token punctuation">,</span> 
		int32 BatchElementIndex<span class="token punctuation">,</span>
		<span class="token keyword keyword-const">const</span> FMeshDrawCommandPrimitiveIdInfo <span class="token operator">&amp;</span>IdInfo<span class="token punctuation">,</span>
		ERasterizerFillMode MeshFillMode<span class="token punctuation">,</span>
		ERasterizerCullMode MeshCullMode<span class="token punctuation">,</span>
		FMeshDrawCommandSortKey SortKey<span class="token punctuation">,</span>
		EFVisibleMeshDrawCommandFlags Flags<span class="token punctuation">,</span>
		<span class="token keyword keyword-const">const</span> FGraphicsMinimalPipelineStateInitializer<span class="token operator">&amp;</span> PipelineState<span class="token punctuation">,</span>
		<span class="token keyword keyword-const">const</span> FMeshProcessorShaders<span class="token operator">*</span> ShadersForDebugging<span class="token punctuation">,</span>
		FMeshDrawCommand<span class="token operator">&amp;</span> MeshDrawCommand<span class="token punctuation">)</span> <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-final">final</span>
	<span class="token punctuation">{</span>
		FGraphicsMinimalPipelineStateId PipelineId <span class="token operator">=</span> <span class="token class-name">FGraphicsMinimalPipelineStateId</span><span class="token double-colon punctuation">::</span><span class="token function">GetPipelineStateId</span><span class="token punctuation">(</span>PipelineState<span class="token punctuation">,</span> GraphicsMinimalPipelineStateSet<span class="token punctuation">,</span> NeedsShaderInitialisation<span class="token punctuation">)</span><span class="token punctuation">;</span>

		MeshDrawCommand<span class="token punctuation">.</span><span class="token function">SetDrawParametersAndFinalize</span><span class="token punctuation">(</span>MeshBatch<span class="token punctuation">,</span> BatchElementIndex<span class="token punctuation">,</span> PipelineId<span class="token punctuation">,</span> ShadersForDebugging<span class="token punctuation">)</span><span class="token punctuation">;</span>

		FVisibleMeshDrawCommand NewVisibleMeshDrawCommand<span class="token punctuation">;</span>
		<span class="token comment">//@todo MeshCommandPipeline - assign usable state ID for dynamic path draws</span>
		<span class="token comment">// Currently dynamic path draws will not get dynamic instancing, but they will be roughly sorted by state</span>
		<span class="token keyword keyword-const">const</span> FMeshBatchElement<span class="token operator">&amp;</span> MeshBatchElement <span class="token operator">=</span> MeshBatch<span class="token punctuation">.</span>Elements<span class="token punctuation">[</span>BatchElementIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
		NewVisibleMeshDrawCommand<span class="token punctuation">.</span><span class="token function">Setup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MeshDrawCommand<span class="token punctuation">,</span> IdInfo<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> MeshFillMode<span class="token punctuation">,</span> MeshCullMode<span class="token punctuation">,</span> Flags<span class="token punctuation">,</span> SortKey<span class="token punctuation">,</span>
			MeshBatchElement<span class="token punctuation">.</span>bIsInstanceRuns <span class="token operator">?</span> MeshBatchElement<span class="token punctuation">.</span>InstanceRuns <span class="token operator">:</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">,</span>
			MeshBatchElement<span class="token punctuation">.</span>bIsInstanceRuns <span class="token operator">?</span> MeshBatchElement<span class="token punctuation">.</span>NumInstances <span class="token operator">:</span> <span class="token number">0</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		DrawList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>NewVisibleMeshDrawCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><h4 id="call-stack3-submit-rhicommand">Call Stack3: Submit RHICommand </h4>
<p><img src="image-10.png" alt="Call Stack3: Submit RHICommand"><br>
在可见性测试后便是渲染的环节，<code>FDeferredShadingSceneRenderer</code>为不同的pass实现了不同的渲染函数并命名为<code>RenderXXXPass</code>(XXX:Pass Name)，执行绘制的入口是该pass对应的<code>ParallelMeshDrawCommandPasses</code>的<code>DispatchDraw</code>方法，以prePass为例，在<code>RenderPrePass</code>函数中，绘制的入口以及pass参数先被加入RDG进行资源的处理，再异步地（由RDG决定顺序）以Lambda函数方式被调用。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// DepthRendering.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">FDeferredShadingSceneRenderer</span><span class="token double-colon punctuation">::</span><span class="token function">RenderPrePass</span><span class="token punctuation">(</span>FRDGBuilder<span class="token operator">&amp;</span> GraphBuilder<span class="token punctuation">,</span> FRDGTextureRef SceneDepthTexture<span class="token punctuation">,</span> FInstanceCullingManager<span class="token operator">&amp;</span> InstanceCullingManager<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
					GraphBuilder<span class="token punctuation">.</span><span class="token function">AddPass</span><span class="token punctuation">(</span>
						<span class="token function">RDG_EVENT_NAME</span><span class="token punctuation">(</span><span class="token string">"DepthPassParallel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						PassParameters<span class="token punctuation">,</span>
						ERDGPassFlags<span class="token double-colon punctuation">::</span>Raster <span class="token operator">|</span> ERDGPassFlags<span class="token double-colon punctuation">::</span>SkipRenderPass<span class="token punctuation">,</span>
						<span class="token punctuation">[</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>View<span class="token punctuation">,</span> PassParameters<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> FRDGPass<span class="token operator">*</span> InPass<span class="token punctuation">,</span> FRHICommandListImmediate<span class="token operator">&amp;</span> RHICmdList<span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						FRDGParallelCommandListSet <span class="token function">ParallelCommandListSet</span><span class="token punctuation">(</span>InPass<span class="token punctuation">,</span> RHICmdList<span class="token punctuation">,</span> <span class="token function">GET_STATID</span><span class="token punctuation">(</span>STAT_CLP_Prepass<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> View<span class="token punctuation">,</span> <span class="token function">FParallelCommandListBindings</span><span class="token punctuation">(</span>PassParameters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						ParallelCommandListSet<span class="token punctuation">.</span><span class="token function">SetHighPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

						View<span class="token punctuation">.</span>ParallelMeshDrawCommandPasses<span class="token punctuation">[</span>EMeshPass<span class="token double-colon punctuation">::</span>DepthPass<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">DispatchDraw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ParallelCommandListSet<span class="token punctuation">,</span> RHICmdList<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PassParameters<span class="token operator">-&gt;</span>InstanceCullingDrawParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><p><code>FDrawVisibleMeshCommandAnyThreadTask</code>执行的绘制指令单个MeshDrawCommand的绘制命令的创建的调用堆栈如下，绘制的任务并不是立即执行的，而是由RDG的<code>Execute()</code>发起执行。<br>
<img src="image-12.png" alt="Alt text"></p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// MeshPassProcessor.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">FMeshDrawCommand</span><span class="token double-colon punctuation">::</span><span class="token function">SubmitDrawEnd</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> FMeshDrawCommand<span class="token operator">&amp;</span> MeshDrawCommand<span class="token punctuation">,</span> uint32 InstanceFactor<span class="token punctuation">,</span> FRHICommandList<span class="token operator">&amp;</span> RHICmdList<span class="token punctuation">,</span>
	FRHIBuffer<span class="token operator">*</span> IndirectArgsOverrideBuffer<span class="token punctuation">,</span>
	uint32 IndirectArgsOverrideByteOffset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    RHICmdList<span class="token punctuation">.</span><span class="token function">DrawIndexedPrimitive</span><span class="token punctuation">(</span>
				MeshDrawCommand<span class="token punctuation">.</span>IndexBuffer<span class="token punctuation">,</span>
				MeshDrawCommand<span class="token punctuation">.</span>VertexParams<span class="token punctuation">.</span>BaseVertexIndex<span class="token punctuation">,</span>
				<span class="token number">0</span><span class="token punctuation">,</span>
				MeshDrawCommand<span class="token punctuation">.</span>VertexParams<span class="token punctuation">.</span>NumVertices<span class="token punctuation">,</span>
				MeshDrawCommand<span class="token punctuation">.</span>FirstIndex<span class="token punctuation">,</span>
				MeshDrawCommand<span class="token punctuation">.</span>NumPrimitives<span class="token punctuation">,</span>
				MeshDrawCommand<span class="token punctuation">.</span>NumInstances <span class="token operator">*</span> InstanceFactor
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>DrawIndexedPrimitive</code>在ByPass情况下会直接调用的方法<code>RHIDrawIndexedPrimitive</code>由不同图形驱动的RHI实现，实测在windows下只有在FD3D12对应的RHI中打断点才会生效，并没有使用到其他图形驱动的RHI。<br>
<code>RHICommandList.h</code><br>
<img src="image-14.png" alt="Alt text"></p>
<p>以OpenGL为例，该方法会直接调用OpenGL的绘制方法如<code>glDrawElementsInstanced</code>和<code>glDrawElements</code>等进行绘制。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token comment">// OpenGLCommands.cpp</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">FOpenGLDynamicRHI</span><span class="token double-colon punctuation">::</span><span class="token function">RHIDrawIndexedPrimitive</span><span class="token punctuation">(</span>FRHIBuffer<span class="token operator">*</span> IndexBufferRHI<span class="token punctuation">,</span> int32 BaseVertexIndex<span class="token punctuation">,</span> uint32 FirstInstance<span class="token punctuation">,</span> uint32 NumVertices<span class="token punctuation">,</span> uint32 StartIndex<span class="token punctuation">,</span> uint32 NumPrimitives<span class="token punctuation">,</span> uint32 NumInstances<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">FOpenGL</span><span class="token double-colon punctuation">::</span><span class="token function">DrawElementsInstanced</span><span class="token punctuation">(</span>DrawMode<span class="token punctuation">,</span> NumElements<span class="token punctuation">,</span> IndexType<span class="token punctuation">,</span> <span class="token function">INDEX_TO_VOID</span><span class="token punctuation">(</span>StartIndex<span class="token punctuation">)</span><span class="token punctuation">,</span> NumInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
    OpenGL3.h
    static FORCEINLINE void DrawElementsInstanced(GLenum Mode, GLsizei Count, GLenum Type, const GLvoid* Indices, GLsizei InstanceCount)
	{
		glDrawElementsInstanced(Mode, Count, Type, Indices, InstanceCount);
	}
    */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">glDrawElements</span><span class="token punctuation">(</span>DrawMode<span class="token punctuation">,</span> NumElements<span class="token punctuation">,</span> IndexType<span class="token punctuation">,</span> <span class="token function">INDEX_TO_VOID</span><span class="token punctuation">(</span>StartIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="example-prepass-depth-pass">Example: PrePass (Depth Pass) </h2>
<h3 id="scene-overview">Scene Overview </h3>
<p>1 Cube + 1 DirectionalLight<br>
<img src="image-33.png" alt="Alt text"></p>
<h3 id="cvars-console-variables-at-engineconfigconsolevariablesini">CVars (Console Variables) at Engine\Config\ConsoleVariables.ini </h3>
<p>虚幻的绘制数据分两类，一类是Dynamic一类是Static，不同的绘制数据的绘制路径是不一样的。Static数据是预生成的，将被保存在CachedMeshDrawCommandStateBuckets里，Dynamic的MeshDrawCommand是每帧重新生成的。按照下图设置cvars以后每帧都会重新生成MeshDrawCommand，方便分析。<br>
<img src="image-9.png" alt="Engine CVars(Console Variables)"></p>
<h3 id="cube相关信息截帧">Cube相关信息截帧 </h3>
<h4 id="几何信息">几何信息 </h4>
<p>在编辑器界面查看Cube的几何信息如下，其中共有一个LOD0、48<code>Triangles</code>和54<code>Vertices</code>等。<br>
<img src="image.png" alt="Alt text"></p>
<h4 id="场景信息">场景信息 </h4>
<p>游戏线程在<code>FRendererModule::BeginRenderingViewFamily</code>中初始化渲染线程的场景渲染器<code>FSceneRenderer</code>，然后在渲染线程执行的方法<code>RenderViewFamilies_RenderThread</code>中调用<code>FSceneRenderer</code>的<code>Render()</code>方法进行渲染。<br>
在渲染线程遍历<code>SceneRenders</code>执行实际的渲染函数<code>Render()</code>前打断点截帧，查看<code>Scene</code>里的<code>Primitives</code>信息，<code>Primitives</code>里的元素实际上是<code>FPrimitiveSceneInfo</code>。<br>
<code>SceneRendering.cpp</code><br>
<img src="image-16.png" alt="Alt text"><br>
场景中共有五个<code>Primitives</code>。<br>
<img src="image-20.png" alt="Alt text"><br>
从<code>Primitives</code>的<code>Proxy</code>的<code>ResourceName</code>和<code>OwnerName</code>中可以看出第一个primitive对应的是Cube，第二个是Sphere代表的DefaultPawn，剩下三个是LineBatchComponent。<br>
<img src="image-19.png" alt="Alt text"><br>
<img src="image-21.png" alt="Alt text"></p>
<h4 id="静态绘制路径缓存meshbatch">静态绘制路径，缓存MeshBatch </h4>
<p>静态绘制路径通常可以被缓存，所以也叫缓存绘制路径，适用的对象可以是静态模型（可在UE编辑器的网格属性面板中指定，见下图）。<br>
<img src="image-30.png" alt="Alt text"><br>
静态模型在加入场景后，其对应的<code>FPrimitiveSceneInfo</code>在调用<code>AddStaticMeshes</code>时，被执行缓存处理，调用堆栈如下所示。<code>AddStaticMeshes</code>中会添加静态网格元素到场景的静态网格列表，也会缓存静态的MeshDrawCommand（如果开启了缓存）。<br>
我们添加且只添加一个静态的Cube到场景。打断点可以发现在执行完<code>AddStaticMeshes</code>后，场景中的<code>StaticMeshes</code>已经有了4个元素，其中第0个和第1个就是我们添加的Cube的<code>FStaticMeshBatch</code>，他们的<code>PrimitiveSceneInfo</code>是一样的。<br>
<img src="image-29.png" alt="Alt text"><br>
<img src="image-31.png" alt="Alt text"></p>
<h4 id="可视性与相关性检测">可视性与相关性检测 </h4>
<p><code>SceneVisibility.cpp</code>里的<code>FsceneRender::ComputeViewVisibility</code>中执行各种剔除与可视性检测，然后在<code>FSceneRenderer::SetupMeshPass</code>中遍历各个pass生成drawcommand。在构建最后的绘制列表之前需要把不需要的MeshDrawCommand剔除掉，UE有多种剔除算法，可见性剔除，视锥体剔除等。最后会构建一个View.PrimitiveVisibilityMap。这个VisibilityMap会把没用的MeshDrawCommand丢掉，让它无法进入最后的渲染队列里。<br>
在进行剔除与可视性检测后的VisibilityMap中可以看到，Cube的可见性标志位为1（可见），Pawn的Sphere的可见性标志位为0（不可见）。<br>
<img src="image-22.png" alt="Alt text"></p>
<p>在<code>FsceneRender::ComputeViewVisibility</code>中还会进行相关性(<code>Relevance</code>)的检测，我们加入场景的<code>Cube</code>是静态物体，场景中已经缓存了它的<code>MeshBatch</code>，但是由于没有缓存它的<code>MeshDrawCommand</code>所以每帧都要重新生成这个静态<code>MeshBatch</code>的<code>MeshDrawCommand</code>。<br>
在<code>ComputeAndMarkRelevanceForViewParallel</code>中会计算相关性并且填充<code>FViewCommands</code>中的<code>NumDynamicMeshCommandBuildRequestElements</code>等信息，这个对应的就是需要构建<code>MeshDrawCommand</code>的静态<code>FMeshBatch</code>的数量，如下图断点所示，在经过相关性计算后，第一个Pass和第二个Pass对应的<code>NumDynamicMeshCommandBuildRequestElements</code>被填充为1，代表该Pass中有一个静态物体生成的<code>FMeshBatch</code>需要构建成<code>MeshDrawCommand</code>。<br>
<img src="image-32.png" alt="Alt text"></p>
<h4 id="设置meshpass与构建meshdrawcommand">设置MeshPass与构建MeshDrawCommand </h4>
<p>在<code>FSceneRenderer::SetupMeshPass</code>中打断点调试可以看到<code>ParallelMeshDrawCommandPasses</code>中的各个Pass的信息被逐个填充，其成员变量<code>TaskContext</code>里有该Pass对应的MeshDrawCommand信息<br>
<code>SceneRendering.cpp</code><br>
<img src="image-18.png" alt="Alt text"></p>
<p>在<code>GenerateDynamicMeshDrawCommands</code>中打断点截帧可以发现，在<code>PrePass</code>构建过程中，没有<code>DynamicMeshBatch</code>，有且只有一个<code>StaticMeshBatch</code>，而且根据其<code>PrimitiveSceneInfo</code>可以确定这个<code>MeshBatch</code>对应的是Cube。<br>
<img src="image-24.png" alt="Alt text"></p>
<p><code>FDepthMeshProcessor::AddMeshBatch</code>会继续调用直到<code>BuildMeshDrawCommand</code>，打断点截帧进行分析，此时的堆栈如下，可以看到堆栈走的是DepthPass的路径。<br>
<img src="image-25.png" alt="Alt text"></p>
<p><code>BuildMeshDrawCommand</code>中创建了<code>FMeshDrawCommand</code>并将其添加到<code>DrawListStorage</code>，如下图断点所示，在执行<code>AddCommand</code>之前，此时的<code>DrawListStorage</code>是空的。<br>
<img src="image-26.png" alt="Alt text"></p>
<p>在执行完<code>AddCommand</code>和<code>FinalizeCommand</code>之后，DepthPass的<code>MeshProcessor</code>中就有了Cube对应的<code>FMeshBatch</code>所生成的<code>FMeshDrawCommand</code>的信息。最终生成的<code>FMeshDrawCommand</code>的信息主要有着色器绑定(ShaderBindings)、顶点流(VertexStreams)、索引缓冲(IndexBuffer)、PSO管线ID(CachedPipelineId)、绘制参数(FirstIndex、NumPrimitive、NumInstances)等。可以看到其中的信息可以和Cube的几何信息相对应。<br>
<img src="image-28.png" alt="Alt text"></p>
<h4 id="设置rhicommandlist与提交绘制命令">设置RHICommandList与提交绘制命令 </h4>
<p><code>FMeshDrawCommand::SubmitDraw</code>中</p>
<hr>
<h2 id="the-entire-scene">The Entire Scene </h2>
<hr>
<h2 id="footnotes">Footnotes </h2>
<h4 id="fmeshbatchelement">FMeshBatchElement </h4>
<p>FMeshBatchElement里面储存了单个网格所需的数据，如IndexBuffer，shaderParameters等</p>
<h4 id="fmeshbatch">FMeshBatch </h4>
<p>FMeshBatch包含了一个pass的所需要的全部渲染数据，它会维护一个FMeshBatchElement列表，FMeshBatchElement包含了单个网格绘制所需的数据，包括UniformBuffer、IndexBuffer等等。事实上，最后一个FMeshBatchElement就对应了一次DrawCall<br>
FMeshBatch解耦了Pass和FPrimitiveSceneProxy，包含了绘制pass所需信息<br>
他拥有一组FmeshBatchElement（但绝大多数情况下只用一个，除了FInstancedStaticMeshSceneProxy和FHierarchicalStaticMeshSceneProxy中的接口会对数组作填充，其余情况都只用到一个FMeshBatchElement），他们共享相同材质的vertexFactory</p>
<h4 id="fmeshelementcollector">FMeshElementCollector </h4>
<p>FMeshElementCollector 由 FSceneRenderer 创建且一一对应。<br>
收集器收集完对应view的可见图元列表后，通常拥有一组需要渲染的FMeshBatch列表，以及它们的管理数据和状态，为后续的流程收集和准备足够的准备。<br>
此外，FMeshElementCollector在收集完网格数据后，还可以指定需要等待处理的任务列表，以实现多线程并行处理的同步。</p>
<h4 id="getdynamicmeshelements--getdynamicelementssection">GetDynamicMeshElements() &amp; GetDynamicElementsSection() </h4>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-void">void</span> <span class="token class-name">FSceneRenderer</span><span class="token double-colon punctuation">::</span><span class="token function">GatherDynamicMeshElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    PrimitiveSceneInfo<span class="token operator">-&gt;</span>Proxy<span class="token operator">-&gt;</span><span class="token function">GetDynamicMeshElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>是给每个图元对象向渲染器（收集器）添加可见图元元素的机会，由具体的子类实现，如 FSkeletalMeshSceneProxy<br>
FSkeletalMeshSceneProxy会根据不同的LOD索引，给每个Section网格添加一个FMeshBatch。</p>
<h4 id="parallelmeshdrawcommandpasses">ParallelMeshDrawCommandPasses </h4>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-void">void</span> <span class="token class-name">FParallelMeshDrawCommandPass</span><span class="token double-colon punctuation">::</span><span class="token function">DispatchPassSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 先收集 TaskContext 信息 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">FMeshDrawCommandPassSetupTask</span><span class="token double-colon punctuation">::</span><span class="token function">AnyThreadTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 使用 TaskContext 信息生成绘制指令、写入数据
    <span class="token class-name">FMeshDrawCommandInitResourcesTask</span><span class="token double-colon punctuation">::</span><span class="token function">AnyThreadTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 使用 TaskContext 信息初始化绘制资源
<span class="token punctuation">}</span>
</code></pre><h4 id="fmeshdrawcommandpasssetuptaskcontext">FMeshDrawCommandPassSetupTaskContext </h4>
<p>收集FMeshDrawCommandPassSetupTask需要的信息</p>
<h4 id="fmeshdrawcommandpasssetuptask">FMeshDrawCommandPassSetupTask </h4>
<p>在FMeshDrawCommandPassSetupTask中进行绘制指令生成与相关数据的写入</p>
<h4 id="fmeshpassprocessor--addmeshbatch--tryaddmeshbatch--buildmeshdrawcommands--fmeshpassdrawlistcontext">FMeshPassProcessor &amp; AddMeshBatch() &amp; TryAddMeshBatch() &amp; BuildMeshDrawCommands() &amp; FMeshPassDrawListContext </h4>
<p>每个Pass都对应了一个FMeshPassProcessor，每个FMeshPassProcessor保存了该Pass需要绘制的所有FMeshDrawCommand，以便渲染器在合适的时间触发并渲染。<br>
不同Pass的通过调用AddMeshBatch()方法处理FMeshBatch中的几何信息，主要的处理在TryAddMeshBatch()中，该方法中进行了shader绑定，渲染转台处理等，最后根据不同的选项和质量选择不同的Process使用BuildMeshDrawCommands()将FMeshBatch转为FMeshDrawCommand<br>
生成的FMeshDrawCommand被保存在FMeshPassDrawListContext中。</p>
<blockquote>
<p>官方文档中对 FMeshPassProcessor 的解释：<br>
<img src="image-1.png" alt="Alt text"></p>
</blockquote>
<h4 id="generatedynamicmeshdrawcommands">GenerateDynamicMeshDrawCommands() </h4>
<p>转换指定EMeshPass中的每个FMeshBatch到一组FMeshDrawCommand。FMeshDrawCommandPassSetupTask要用到。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-void">void</span> <span class="token function">GenerateDynamicMeshDrawCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    PassMeshProcessor<span class="token operator">-&gt;</span><span class="token function">AddMeshBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="fmeshdrawcommand">FMeshDrawCommand </h4>
<p>内有资源绑定信息如着色器绑定(ShaderBindings)、顶点流(VertexStreams)、索引缓冲(IndexBuffer)、PSO管线ID(CachedPipelineId)、绘制参数(FirstIndex、NumPrimitive、NumInstances)等。</p>
<blockquote>
<p>FMeshDrawCommand（网格绘制指令），记录了绘制单个Mesh所需的所有资源和数据，且不应该有多余的数据，如果需要在InitView传递数据，可用FVisibleMeshDrawCommand。</p>
</blockquote>
<h4 id="fparallelmeshdrawcommandpass--dispatchpasssetup--dispatchdraw">FParallelMeshDrawCommandPass &amp; DispatchPassSetup() &amp; DispatchDraw() </h4>
<p>Encapsulates two parallel tasks - mesh command setup task and drawing task<br>
DispatchPassSetup() 对应 mesh command setup task<br>
DispatchDraw() 对应 drawing task<br>
同时保存着该pass的meshdrawcommand</p>
<h4 id="rhicommand">RHICommand </h4>
<p>RHI全称Rendering Hardware Interface（渲染硬件接口），是不同图形API的抽象层，而RHICommandList便是负责收录与图形API无关的中间层绘制指令和数据。</p>
<h4 id="rhicommandlist">RHICommandList </h4>
<p>RHICommandList收录了一系列中间绘制指令之后，会在RHI线程一一转换到对应目标图形API的接口</p>
<h4 id="rdg">RDG </h4>
<p>RDG全称是Rendering Dependency Graph，意为渲染依赖性图表，是UE4.22开始引进的全新的渲染子系统，基于有向无环图(Directed Acyclic Graph，DAG)的调度系统，用于执行渲染管线的整帧优化。UE中使用RDG代替原本直接调用RHI命令的方式，由RDG调整资源的生命周期，裁剪Pass，处理Pass的资源转换和屏障，处理异步计算Pass的依赖和引用关系，查找并建立分叉和合并Pass节点，合并所有具体相同渲染目标的光栅化Pass等。</p>
<h4 id="frdgpass">FRDGPass </h4>
<p>RDGPass和渲染Pass并非一一对应关系，有可能多个RDGPass合并成一个渲染Pass。</p>
<hr>
<h2 id="reference">Reference </h2>
<ol start="0">
<li><a href="https://docs.unrealengine.com/5.2/zh-CN/mesh-drawing-pipeline-in-unreal-engine/">虚幻引擎网格体绘制管道 | 虚幻引擎5.2文档</a></li>
<li><a href="https://www.cnblogs.com/timlly/p/14588598.html#322-%E4%BB%8Efprimitivesceneproxy%E5%88%B0fmeshbatch">剖析虚幻渲染体系（03）- 渲染机制 - 0向往0 - 博客园</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/574116410">UE5【理论】1.网格绘制管线MeshDrawPipeline</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/61464613">虚幻4渲染编程(Shader篇)【第十二卷：MeshDrawPipline】</a></li>
<li><a href=""></a></li>
</ol>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>